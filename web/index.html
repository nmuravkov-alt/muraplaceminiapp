<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="referrer" content="no-referrer"/>
  <title>LAYOUTPLACE Shop</title>

  <link rel="stylesheet" href="/web/style.css?v=7"/>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="/web/app.js?v=7" defer></script>
</head>
<body>

  <!-- ===== –ü–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä —Ñ–æ—Ç–æ ===== -->
  <div id="imgViewer" class="hidden">
    <img src="" alt="preview"/>
  </div>

  <header class="topbar">
    <div>
      <div id="shopTitle" class="shop-title"></div>
      <div id="subtitle" class="subtitle"></div>
    </div>
    <button id="cartBtn" class="cart-btn" aria-label="–ö–æ—Ä–∑–∏–Ω–∞">
      üõí <span id="cartCount">0</span>
    </button>
  </header>

  <main class="container">
    <div id="hero" class="hero hidden"></div>
    <div id="categories" class="cat-grid"></div>
    <div id="products" class="products"></div>
  </main>

  <footer class="bottom">
    <button id="writeBtn" class="btn ghost">–ù–∞–ø–∏—Å–∞—Ç—å</button>
    <button id="checkoutBtn" class="btn primary">–û—Ñ–æ—Ä–º–∏—Ç—å</button>
  </footer>

  <div id="sheet" class="sheet hidden"></div>
  <div id="backdrop" class="backdrop hidden"></div>

  <script>
    const viewer = document.getElementById("imgViewer");
    const viewerImg = viewer.querySelector("img");

    let album = [];
    let idx = 0;

    let startX = 0, startY = 0;
    let scale = 1, startDist = 0;

    function setImage(i) {
      if (!album.length) return;
      idx = (i + album.length) % album.length;
      viewerImg.src = album[idx];
      scale = 1;
      viewerImg.style.transform = "scale(1)";
    }

    function openViewerFromAlbum(list, startIndex = 0) {
      album = (list || []).map(s => (s || "").trim()).filter(Boolean);
      if (!album.length) return;

      viewer.classList.remove("hidden");
      document.body.style.overflow = "hidden";

      setImage(startIndex);
    }

    function closeViewer() {
      viewer.classList.add("hidden");
      viewerImg.src = "";
      document.body.style.overflow = "";

      album = [];
      idx = 0;
      scale = 1;
      startDist = 0;
      viewerImg.style.transform = "scale(1)";
    }

    function next() { setImage(idx + 1); }
    function prev() { setImage(idx - 1); }

    // –ó–∞–∫—Ä—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Ç–∞–ø –ø–æ —Ñ–æ–Ω—É (–ù–ï –ø–æ img)
    viewer.addEventListener("click", (e) => {
      if (e.target === viewer) closeViewer();
    });

    // Touch start
    viewer.addEventListener("touchstart", (e) => {
      if (e.touches.length === 1) {
        startX = e.touches[0].clientX;
        startY = e.touches[0].clientY;
      }
      if (e.touches.length === 2) {
        const dx = e.touches[1].clientX - e.touches[0].clientX;
        const dy = e.touches[1].clientY - e.touches[0].clientY;
        startDist = Math.sqrt(dx*dx + dy*dy);
      }
    }, { passive: true });

    // Touch move (zoom + swipe down close)
    viewer.addEventListener("touchmove", (e) => {
      if (e.touches.length === 2 && startDist) {
        const dx = e.touches[1].clientX - e.touches[0].clientX;
        const dy = e.touches[1].clientY - e.touches[0].clientY;
        const newDist = Math.sqrt(dx*dx + dy*dy);

        scale *= newDist / startDist;
        startDist = newDist;
        scale = Math.max(1, Math.min(scale, 4));
        viewerImg.style.transform = `scale(${scale})`;
        return;
      }

      if (e.touches.length === 1 && startY) {
        const dy = e.touches[0].clientY - startY;
        if (dy > 140) closeViewer();
      }
    }, { passive: true });

    // Touch end (horizontal swipe)
    viewer.addEventListener("touchend", (e) => {
      if (!album.length) return;

      startDist = 0;

      const t = (e.changedTouches && e.changedTouches[0]) ? e.changedTouches[0] : null;
      if (!t) return;

      const endX = t.clientX;
      const endY = t.clientY;

      const dx = endX - startX;
      const dy = endY - startY;

      if (Math.abs(dx) > 60 && Math.abs(dx) > Math.abs(dy)) {
        if (dx < 0) next();
        else prev();
      }

      startX = 0; startY = 0;
    });

    // –ö–ª–∞–≤–∏—à–∏
    window.addEventListener("keydown", (e) => {
      if (e.key === "Escape" && !viewer.classList.contains("hidden")) closeViewer();
      if (e.key === "ArrowRight" && album.length) next();
      if (e.key === "ArrowLeft"  && album.length) prev();
    });

    // üî• –û—Ç–∫—Ä—ã—Ç–∏–µ viewer (CAPTURE), —á—Ç–æ–±—ã –Ω–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤–∞—Ç—å —Å –¥—Ä—É–≥–∏–º–∏ –∫–ª–∏–∫–∞–º–∏
    document.addEventListener("click", (e) => {
      const img = e.target.closest(".thumb img, .hero-img img");
      if (!img) return;

      e.preventDefault();
      e.stopPropagation();

      const albumRaw = img.getAttribute("data-album") || "";
      const list = albumRaw
        ? albumRaw.split("|").map(s => s.trim()).filter(Boolean)
        : [img.getAttribute("src")].filter(Boolean);

      openViewerFromAlbum(list, 0);
    }, true); // üëà capture = true
  </script>

</body>
</html>